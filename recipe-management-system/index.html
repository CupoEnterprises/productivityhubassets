<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1a2e">
  <title>Recipe Manager</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #0f3460;
      --accent: #e94560;
      --accent-hover: #ff6b81;
      --text-primary: #eee;
      --text-secondary: #a0a0b8;
      --success: #2ecc71;
      --error: #e74c3c;
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    /* --- Login Screen --- */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      min-height: 100dvh;
      padding: 24px;
    }

    #login-screen h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    #login-screen p {
      color: var(--text-secondary);
      margin-bottom: 32px;
      font-size: 14px;
    }

    #login-form {
      width: 100%;
      max-width: 320px;
    }

    #login-form input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--border-radius);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 16px;
      outline: none;
      transition: border-color 0.2s;
    }

    #login-form input:focus {
      border-color: var(--accent);
    }

    /* --- App Screen --- */
    #app-screen {
      display: none;
      flex-direction: column;
      min-height: 100vh;
      min-height: 100dvh;
    }

    /* Header */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .app-header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .logout-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
    }

    /* Main Content */
    .app-content {
      flex: 1;
      padding: 20px;
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 4px;
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      padding: 4px;
      margin-bottom: 24px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: var(--accent);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Photo Tab */
    .photo-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .camera-btn {
      width: 100%;
      padding: 48px 24px;
      border: 2px dashed rgba(255,255,255,0.15);
      border-radius: var(--border-radius);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .camera-btn:hover, .camera-btn:active {
      border-color: var(--accent);
      background: rgba(233, 69, 96, 0.05);
    }

    .camera-btn svg {
      width: 48px;
      height: 48px;
      opacity: 0.6;
    }

    .camera-btn span {
      font-size: 15px;
    }

    #photo-input {
      display: none;
    }

    .preview-container {
      display: none;
      width: 100%;
      position: relative;
    }

    .preview-container img {
      width: 100%;
      border-radius: var(--border-radius);
      max-height: 300px;
      object-fit: contain;
      background: var(--bg-secondary);
    }

    .remove-preview {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0,0,0,0.7);
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Text Tab */
    .text-area-container {
      width: 100%;
    }

    .text-area-container textarea {
      width: 100%;
      min-height: 240px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--border-radius);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.6;
      resize: vertical;
      outline: none;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .text-area-container textarea:focus {
      border-color: var(--accent);
    }

    .text-area-container textarea::placeholder {
      color: var(--text-secondary);
    }

    .char-count {
      text-align: right;
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 6px;
    }

    /* Submit Button */
    .submit-btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: var(--border-radius);
      background: var(--accent);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-btn:hover {
      background: var(--accent-hover);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .submit-btn .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .submit-btn.loading .spinner {
      display: block;
    }

    .submit-btn.loading .btn-text {
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Status Messages */
    .status-msg {
      display: none;
      padding: 14px 16px;
      border-radius: var(--border-radius);
      margin-top: 16px;
      font-size: 14px;
      line-height: 1.5;
    }

    .status-msg.success {
      display: block;
      background: rgba(46, 204, 113, 0.12);
      color: var(--success);
      border: 1px solid rgba(46, 204, 113, 0.2);
    }

    .status-msg.error {
      display: block;
      background: rgba(231, 76, 60, 0.12);
      color: var(--error);
      border: 1px solid rgba(231, 76, 60, 0.2);
    }

    /* History Section */
    .history-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    .history-section h3 {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border-radius: 10px;
      font-size: 14px;
    }

    .history-item .title {
      font-weight: 500;
    }

    .history-item .time {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .empty-history {
      color: var(--text-secondary);
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }

    /* Responsive */
    @media (max-width: 380px) {
      .app-content { padding: 16px; }
      .tab-btn { font-size: 13px; padding: 9px 6px; }
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="login-screen">
    <h1>Recipe Manager</h1>
    <p>Enter password to continue</p>
    <form id="login-form" onsubmit="handleLogin(event)">
      <input type="password" id="password-input" placeholder="Password" autocomplete="current-password" required>
      <button type="submit" class="submit-btn">
        <span class="btn-text">Sign In</span>
      </button>
      <div id="login-error" class="status-msg"></div>
    </form>
  </div>

  <!-- App Screen -->
  <div id="app-screen">
    <header class="app-header">
      <h1>Recipe Manager</h1>
      <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
    </header>

    <main class="app-content">
      <!-- Tabs -->
      <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('photo')">Photo</button>
        <button class="tab-btn" onclick="switchTab('text')">Paste Text</button>
      </div>

      <!-- Photo Tab -->
      <div id="tab-photo" class="tab-content active">
        <div class="photo-area">
          <label class="camera-btn" for="photo-input" id="camera-label">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z" />
            </svg>
            <span>Tap to take or select a photo</span>
          </label>
          <input type="file" id="photo-input" accept="image/*" capture="environment" onchange="handlePhotoSelect(event)">
          <div class="preview-container" id="preview-container">
            <img id="preview-img" src="" alt="Recipe preview">
            <button class="remove-preview" onclick="removePhoto()" aria-label="Remove photo">&times;</button>
          </div>
        </div>
      </div>

      <!-- Text Tab -->
      <div id="tab-text" class="tab-content">
        <div class="text-area-container">
          <textarea id="recipe-text" placeholder="Paste your recipe text here...&#10;&#10;Include the title, ingredients, and instructions." oninput="updateCharCount()"></textarea>
          <div class="char-count"><span id="char-count">0</span> characters</div>
        </div>
      </div>

      <!-- Submit -->
      <button class="submit-btn" id="submit-btn" onclick="handleSubmit()" disabled>
        <span class="btn-text">Submit Recipe</span>
        <div class="spinner"></div>
      </button>

      <div id="status-msg" class="status-msg"></div>

      <!-- Recent Submissions -->
      <div class="history-section">
        <h3>Recent Submissions</h3>
        <div class="history-list" id="history-list">
          <div class="empty-history">No recipes submitted yet</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ============================================================
    // CONFIGURATION - Update these values before deploying
    // ============================================================
    const CONFIG = {
      // n8n webhook URL for Recipe Intake workflow
      WEBHOOK_URL: '', // e.g., 'https://your-n8n.example.com/webhook/recipe-intake'
      // Password hash (SHA-256 of your chosen password)
      // Default: 'recipe123' -> update via generatePasswordHash() in browser console
      PASSWORD_HASH: '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8' // 'password'
    };

    // ============================================================
    // STATE
    // ============================================================
    let currentTab = 'photo';
    let selectedPhoto = null; // base64 string
    let selectedPhotoFile = null;

    // ============================================================
    // AUTH
    // ============================================================
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function handleLogin(e) {
      e.preventDefault();
      const pw = document.getElementById('password-input').value;
      const hash = await sha256(pw);
      if (hash === CONFIG.PASSWORD_HASH) {
        sessionStorage.setItem('authenticated', 'true');
        showApp();
      } else {
        const errEl = document.getElementById('login-error');
        errEl.className = 'status-msg error';
        errEl.textContent = 'Incorrect password. Please try again.';
      }
    }

    function handleLogout() {
      sessionStorage.removeItem('authenticated');
      showLogin();
    }

    function showApp() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app-screen').style.display = 'flex';
      renderHistory();
    }

    function showLogin() {
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('app-screen').style.display = 'none';
      document.getElementById('password-input').value = '';
      document.getElementById('login-error').className = 'status-msg';
    }

    // Check session on load
    if (sessionStorage.getItem('authenticated') === 'true') {
      showApp();
    }

    // ============================================================
    // TABS
    // ============================================================
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelector(`.tab-btn:nth-child(${tab === 'photo' ? 1 : 2})`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
      updateSubmitState();
    }

    // ============================================================
    // PHOTO HANDLING
    // ============================================================
    function handlePhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      selectedPhotoFile = file;
      const reader = new FileReader();
      reader.onload = function(e) {
        selectedPhoto = e.target.result;
        document.getElementById('preview-img').src = selectedPhoto;
        document.getElementById('preview-container').style.display = 'block';
        document.getElementById('camera-label').style.display = 'none';
        updateSubmitState();
      };
      reader.readAsDataURL(file);
    }

    function removePhoto() {
      selectedPhoto = null;
      selectedPhotoFile = null;
      document.getElementById('photo-input').value = '';
      document.getElementById('preview-container').style.display = 'none';
      document.getElementById('camera-label').style.display = 'flex';
      updateSubmitState();
    }

    // ============================================================
    // TEXT HANDLING
    // ============================================================
    function updateCharCount() {
      const count = document.getElementById('recipe-text').value.length;
      document.getElementById('char-count').textContent = count;
      updateSubmitState();
    }

    // ============================================================
    // SUBMIT
    // ============================================================
    function updateSubmitState() {
      const btn = document.getElementById('submit-btn');
      if (currentTab === 'photo') {
        btn.disabled = !selectedPhoto;
      } else {
        btn.disabled = document.getElementById('recipe-text').value.trim().length < 10;
      }
    }

    async function handleSubmit() {
      if (!CONFIG.WEBHOOK_URL) {
        showStatus('error', 'Webhook URL not configured. Update CONFIG.WEBHOOK_URL in index.html.');
        return;
      }

      const btn = document.getElementById('submit-btn');
      btn.classList.add('loading');
      btn.disabled = true;
      hideStatus();

      try {
        let body;
        let contentType;

        if (currentTab === 'photo' && selectedPhoto) {
          // Send image as base64 JSON payload
          body = JSON.stringify({
            type: 'image',
            image: selectedPhoto, // data:image/...;base64,... format
            timestamp: new Date().toISOString()
          });
          contentType = 'application/json';
        } else {
          // Send text
          const text = document.getElementById('recipe-text').value.trim();
          body = JSON.stringify({
            type: 'text',
            text: text,
            timestamp: new Date().toISOString()
          });
          contentType = 'application/json';
        }

        const response = await fetch(CONFIG.WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': contentType },
          body: body
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }

        const result = await response.json().catch(() => ({}));
        const title = result.title || (currentTab === 'photo' ? 'Photo recipe' : 'Text recipe');

        showStatus('success', `Recipe "${title}" submitted successfully! It will appear in your Google Sheet and Notion shortly.`);
        addToHistory(title);
        resetForm();
      } catch (err) {
        console.error('Submit error:', err);
        showStatus('error', `Failed to submit recipe: ${err.message}. Please check your connection and try again.`);
      } finally {
        btn.classList.remove('loading');
        updateSubmitState();
      }
    }

    function resetForm() {
      removePhoto();
      document.getElementById('recipe-text').value = '';
      updateCharCount();
    }

    // ============================================================
    // STATUS MESSAGES
    // ============================================================
    function showStatus(type, message) {
      const el = document.getElementById('status-msg');
      el.className = `status-msg ${type}`;
      el.textContent = message;
    }

    function hideStatus() {
      document.getElementById('status-msg').className = 'status-msg';
    }

    // ============================================================
    // HISTORY (localStorage)
    // ============================================================
    function getHistory() {
      try {
        return JSON.parse(localStorage.getItem('recipe_history') || '[]');
      } catch { return []; }
    }

    function addToHistory(title) {
      const history = getHistory();
      history.unshift({
        title: title,
        time: new Date().toLocaleString()
      });
      // Keep last 20
      if (history.length > 20) history.pop();
      localStorage.setItem('recipe_history', JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      const list = document.getElementById('history-list');
      const history = getHistory();
      if (history.length === 0) {
        list.innerHTML = '<div class="empty-history">No recipes submitted yet</div>';
        return;
      }
      list.innerHTML = history.map(item => `
        <div class="history-item">
          <span class="title">${escapeHtml(item.title)}</span>
          <span class="time">${escapeHtml(item.time)}</span>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================================
    // UTILITY: Generate password hash (run in browser console)
    // Usage: generatePasswordHash('yourpassword').then(console.log)
    // ============================================================
    window.generatePasswordHash = async function(password) {
      const hash = await sha256(password);
      console.log(`Password: ${password}`);
      console.log(`SHA-256: ${hash}`);
      console.log('Update CONFIG.PASSWORD_HASH with this value.');
      return hash;
    };
  </script>
</body>
</html>
